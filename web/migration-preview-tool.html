<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration & Cleanup Preview Tool</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .input-group {
            margin: 20px 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        button.warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .status {
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .success-status {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .warning-status {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .error-status {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .info-status {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }

        .log-container {
            margin-top: 30px;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .log-header h3 {
            margin: 0;
            color: #333;
        }

        .clear-log-btn {
            background: #e0e0e0;
            color: #333;
            padding: 8px 15px;
            font-size: 12px;
        }

        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }

        .log:empty::before {
            content: 'Console output will appear here...';
            color: #666;
            font-style: italic;
        }

        .log-timestamp {
            color: #858585;
        }

        .log-error {
            color: #f48771;
        }

        .log-success {
            color: #4ec9b0;
        }

        .log-warning {
            color: #dcdcaa;
        }

        .section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            margin-top: 0;
            color: #333;
            font-size: 20px;
        }

        .section-description {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .checkbox-group {
            margin: 15px 0;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            cursor: pointer;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .result-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .result-card h4 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .result-label {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Migration & Cleanup Preview Tool</h1>
        <p class="subtitle">Validate, preview, and execute data migrations and cleanups with confidence</p>

        <div class="input-group">
            <label for="scenarioId">Scenario ID:</label>
            <input type="text" id="scenarioId" placeholder="Enter scenario ID (e.g., rorezNdd5fHpbSgkQ0NV)">
        </div>

        <!-- Validation Section -->
        <div class="section">
            <h2>üìä Validation & Analysis</h2>
            <p class="section-description">Run read-only checks to understand your data quality</p>

            <div class="button-grid">
                <button class="success" onclick="runQuickValidation()">
                    üîç Quick Validation
                </button>
                <button class="success" onclick="showOrphanedCostsAnalysis()">
                    üí∞ Orphaned Costs
                </button>
                <button class="success" onclick="showCostDistribution()">
                    üìà Cost Distribution
                </button>
                <button class="success" onclick="previewMigrationChanges()">
                    üëÅÔ∏è Preview Migration
                </button>
            </div>
        </div>

        <!-- Cleanup Section -->
        <div class="section">
            <h2>üßπ Data Cleanup</h2>
            <p class="section-description">Fix data integrity issues like orphaned costs and inconsistent naming</p>

            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="autoReassign" checked>
                    <span>Auto-reassign orphaned costs when match found</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="autoDelete">
                    <span>Auto-delete orphaned costs with no match (‚ö†Ô∏è use with caution)</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="standardizeNaming" checked>
                    <span>Standardize field naming (destination_id)</span>
                </label>
            </div>

            <div class="button-grid">
                <button class="warning" onclick="runCleanupPreview()">
                    üëÅÔ∏è Preview Cleanup (Dry-Run)
                </button>
                <button class="secondary" onclick="runCleanupWithSave()">
                    üßπ Run Cleanup & Save
                </button>
            </div>
        </div>

        <!-- Migration Section -->
        <div class="section">
            <h2>üîÑ UUID Migration</h2>
            <p class="section-description">Migrate legacy numeric IDs to UUIDs for better data stability</p>

            <div class="button-grid">
                <button class="warning" onclick="previewMigrationChanges()">
                    üëÅÔ∏è Preview Migration (Dry-Run)
                </button>
                <button class="secondary" onclick="executeMigration()">
                    üöÄ Execute Migration & Save
                </button>
            </div>
        </div>

        <!-- Status Display -->
        <div id="status"></div>

        <!-- Console Output -->
        <div class="log-container">
            <div class="log-header">
                <h3>Console Output</h3>
                <button class="clear-log-btn" onclick="clearLog()">Clear Log</button>
            </div>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- Load dependencies -->
    <script type="module">
        import * as DestinationIdManager from './destination-id-manager.js';
        import * as DataCleanup from './data-cleanup-tool.js';
        import * as UUIDMigration from './uuid-migration-refactored.js';

        // Make modules available globally for inline onclick handlers
        window.DestinationIdManager = DestinationIdManager;
        window.DataCleanup = DataCleanup;
        window.UUIDMigration = UUIDMigration;
    </script>

    <script>
        // Console output capture
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        const logDiv = document.getElementById('log');

        function appendToLog(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');

            const span = document.createElement('span');
            span.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> <span class="log-${type}">${escapeHtml(message)}</span>\n`;
            logDiv.appendChild(span);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            appendToLog('success', ...args);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            appendToLog('error', ...args);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            appendToLog('warning', ...args);
        };

        // Clear log
        window.clearLog = function() {
            logDiv.innerHTML = '';
        };

        // Show status message
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            const statusClass = type === 'success' ? 'success-status' :
                               type === 'warning' ? 'warning-status' :
                               type === 'error' ? 'error-status' : 'info-status';

            statusDiv.innerHTML = `<div class="status ${statusClass}">${message}</div>`;

            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 8000);
        }

        // Get scenario ID
        function getCurrentScenarioId() {
            const input = document.getElementById('scenarioId');
            const scenarioId = input.value.trim();

            if (!scenarioId) {
                if (window.currentScenarioId) {
                    input.value = window.currentScenarioId;
                    return window.currentScenarioId;
                }
                showStatus('‚ö†Ô∏è Please enter a scenario ID', 'error');
                return null;
            }

            return scenarioId;
        }

        // Validation functions
        window.runQuickValidation = async function() {
            const scenarioId = getCurrentScenarioId();
            if (!scenarioId) return;

            showStatus('üîç Running validation...', 'info');

            try {
                const result = await window.quickValidation(scenarioId);
                showStatus('‚úÖ Validation complete! Check console for details.', 'success');
            } catch (error) {
                showStatus(`‚ùå Validation error: ${error.message}`, 'error');
            }
        };

        window.showOrphanedCostsAnalysis = async function() {
            const scenarioId = getCurrentScenarioId();
            if (!scenarioId) return;

            showStatus('üí∞ Analyzing orphaned costs...', 'info');

            try {
                const result = await window.showOrphanedCosts(scenarioId);
                showStatus(`‚úÖ Found ${result.length} orphaned costs. Check console for details.`, 'success');
            } catch (error) {
                showStatus(`‚ùå Analysis error: ${error.message}`, 'error');
            }
        };

        window.showCostDistribution = async function() {
            const scenarioId = getCurrentScenarioId();
            if (!scenarioId) return;

            showStatus('üìà Analyzing cost distribution...', 'info');

            try {
                await window.showCostDistribution(scenarioId);
                showStatus('‚úÖ Cost distribution analysis complete!', 'success');
            } catch (error) {
                showStatus(`‚ùå Analysis error: ${error.message}`, 'error');
            }
        };

        // Cleanup functions
        window.runCleanupPreview = async function() {
            const scenarioId = getCurrentScenarioId();
            if (!scenarioId) return;

            const autoReassign = document.getElementById('autoReassign').checked;
            const autoDelete = document.getElementById('autoDelete').checked;
            const standardizeNaming = document.getElementById('standardizeNaming').checked;

            showStatus('üëÅÔ∏è Running cleanup preview (dry-run)...', 'info');

            try {
                const result = await window.runDataCleanup(scenarioId, {
                    autoReassign,
                    autoDelete,
                    standardizeNaming,
                    saveToDB: false
                });

                if (result.success) {
                    showStatus('‚úÖ Cleanup preview complete! No changes saved. Check console for details.', 'success');
                } else {
                    showStatus(`‚ùå Cleanup preview failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Cleanup error: ${error.message}`, 'error');
            }
        };

        window.runCleanupWithSave = async function() {
            const scenarioId = getCurrentScenarioId();
            if (!scenarioId) return;

            const autoReassign = document.getElementById('autoReassign').checked;
            const autoDelete = document.getElementById('autoDelete').checked;
            const standardizeNaming = document.getElementById('standardizeNaming').checked;

            if (!confirm('‚ö†Ô∏è This will modify your data. Continue?')) {
                return;
            }

            showStatus('üßπ Running cleanup and saving...', 'warning');

            try {
                const result = await window.runDataCleanup(scenarioId, {
                    autoReassign,
                    autoDelete,
                    standardizeNaming,
                    saveToDB: true
                });

                if (result.success && result.changes.saved) {
                    showStatus('‚úÖ Cleanup completed and saved successfully!', 'success');
                    setTimeout(() => {
                        if (confirm('Reload the page to see changes?')) {
                            window.location.reload();
                        }
                    }, 2000);
                } else if (result.success) {
                    showStatus('‚ö†Ô∏è Cleanup completed but save failed. Check console.', 'warning');
                } else {
                    showStatus(`‚ùå Cleanup failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Cleanup error: ${error.message}`, 'error');
            }
        };

        // Migration functions
        window.previewMigrationChanges = async function() {
            const scenarioId = getCurrentScenarioId();
            if (!scenarioId) return;

            showStatus('üëÅÔ∏è Previewing migration (dry-run)...', 'info');

            try {
                const result = await window.previewMigration(scenarioId);

                if (result.success) {
                    const msg = `‚úÖ Migration preview complete! Would migrate ${result.migrated} locations and ${result.costsMigrated} costs.`;
                    showStatus(msg, 'success');
                } else {
                    showStatus(`‚ùå Migration preview failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Migration error: ${error.message}`, 'error');
            }
        };

        window.executeMigration = async function() {
            const scenarioId = getCurrentScenarioId();
            if (!scenarioId) return;

            if (!confirm('‚ö†Ô∏è This will migrate legacy IDs to UUIDs. Continue?')) {
                return;
            }

            showStatus('üöÄ Executing migration...', 'warning');

            try {
                const result = await window.migrateLegacyIdsToUUIDs(scenarioId, { dryRun: false, saveToDB: true });

                if (result.success && result.saved) {
                    showStatus(`‚úÖ Migration completed! Migrated ${result.migrated} locations and ${result.costsMigrated} costs.`, 'success');
                    setTimeout(() => {
                        if (confirm('Reload the page to see changes?')) {
                            window.location.reload();
                        }
                    }, 2000);
                } else if (result.success) {
                    showStatus(`‚ö†Ô∏è Migration completed but save failed. Check console.`, 'warning');
                } else {
                    showStatus(`‚ùå Migration failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Migration error: ${error.message}`, 'error');
            }
        };

        // Auto-populate scenario ID if available
        if (window.currentScenarioId) {
            document.getElementById('scenarioId').value = window.currentScenarioId;
        }

        console.log('‚úÖ Migration & Cleanup Preview Tool loaded!');
        console.log('All tools are ready to use via the UI buttons.');
    </script>
</body>
</html>
