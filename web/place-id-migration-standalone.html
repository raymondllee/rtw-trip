<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place ID to UUID Migration</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 { color: #333; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 30px; line-height: 1.6; }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .info-box h3 {
            margin-top: 0;
            color: #1976d2;
        }
        .info-box ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .info-box code {
            background: rgba(0,0,0,0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        .input-group { margin: 20px 0; }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        button:hover:not(:disabled) { transform: translateY(-2px); }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .status {
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .success-status { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .error-status { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .info-status { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        .warning-status { background: #fff3cd; color: #856404; border: 2px solid #ffeaa7; }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Place ID to UUID Migration</h1>
        <p class="subtitle">
            Migrate destinations from using Google Place IDs as primary keys to UUIDs,
            while preserving Place IDs as metadata. This matches the current architecture
            for new destinations.
        </p>

        <div class="info-box">
            <h3>Why Migrate?</h3>
            <ul>
                <li><strong>Consistency:</strong> New destinations already use UUIDs</li>
                <li><strong>Flexibility:</strong> Allow same place to appear multiple times</li>
                <li><strong>Future-proof:</strong> Not dependent on Google's Place ID system</li>
                <li><strong>Safe:</strong> Place IDs are preserved in the <code>place_id</code> field</li>
            </ul>
        </div>

        <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107;">
            <h3>What Gets Changed?</h3>
            <ul>
                <li><code>id</code>: ChIJ... ‚Üí UUID (a1b2c3d4-...)</li>
                <li><code>place_id</code>: ChIJ... (preserved)</li>
                <li><code>_legacy_id</code>: ChIJ... (backup)</li>
                <li>All cost <code>destination_id</code> references updated</li>
            </ul>
        </div>

        <div class="input-group">
            <label for="scenarioId">Scenario ID:</label>
            <input type="text" id="scenarioId" placeholder="Enter scenario ID or load from main app">
        </div>

        <div class="button-group">
            <button class="success" onclick="runPreview()" id="previewBtn">
                üëÅÔ∏è Preview Migration (Safe)
            </button>
            <button class="secondary" onclick="runMigration()" id="migrateBtn" disabled>
                üöÄ Execute Migration
            </button>
        </div>

        <div id="status"></div>
        <div id="log" class="log"></div>
    </div>

    <script>
        const logDiv = document.getElementById('log');
        const statusDiv = document.getElementById('status');

        // Console capture
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function appendToLog(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            appendToLog('log', ...args);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            appendToLog('error', '‚ùå', ...args);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            appendToLog('warn', '‚ö†Ô∏è', ...args);
        };

        function showStatus(message, type = 'info') {
            statusDiv.innerHTML = `<div class="status ${type}-status">${message}</div>`;
        }

        // Helper functions
        function isUUID(id) {
            if (typeof id !== 'string') return false;
            return /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(id);
        }

        function isPlaceId(id) {
            if (typeof id !== 'string') return false;
            return id.startsWith('ChIJ') || id.startsWith('GhIJ') || id.startsWith('EhIJ');
        }

        function generateUUID() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function getScenarioId() {
            let scenarioId = document.getElementById('scenarioId').value.trim();
            if (!scenarioId && window.opener?.currentScenarioId) {
                scenarioId = window.opener.currentScenarioId;
                document.getElementById('scenarioId').value = scenarioId;
            }
            if (!scenarioId && window.currentScenarioId) {
                scenarioId = window.currentScenarioId;
                document.getElementById('scenarioId').value = scenarioId;
            }
            if (!scenarioId) {
                showStatus('‚ö†Ô∏è Please enter a scenario ID or open from main app', 'error');
                return null;
            }
            return scenarioId;
        }

        function getWorkingData() {
            // Try to get from opener window (if opened from main app)
            if (window.opener?.appWorkingData) {
                return window.opener.appWorkingData;
            }
            // Try to get from current window
            if (window.appWorkingData) {
                return window.appWorkingData;
            }
            return null;
        }

        let migrationPlan = null;

        window.runPreview = async function() {
            const scenarioId = getScenarioId();
            if (!scenarioId) return;

            const workingData = getWorkingData();
            if (!workingData) {
                showStatus('‚ö†Ô∏è No working data found. Please open this page from the main app (index.html)', 'error');
                console.error('Cannot find appWorkingData. Make sure to:');
                console.error('1. Open the main app (index.html)');
                console.error('2. Load your scenario');
                console.error('3. Then open this migration tool');
                return;
            }

            logDiv.textContent = '';
            showStatus('üëÅÔ∏è Running migration preview...', 'info');
            document.getElementById('previewBtn').disabled = true;

            try {
                const locations = workingData.locations || [];
                const costs = workingData.costs || [];

                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üîÑ PLACE ID TO UUID MIGRATION PREVIEW');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
                console.log(`Scenario: ${scenarioId}\n`);

                // Analyze current state
                const placeIdLocations = locations.filter(loc => isPlaceId(loc.id));
                const uuidLocations = locations.filter(loc => isUUID(loc.id));

                console.log('üìä Current state:');
                console.log(`  Total locations: ${locations.length}`);
                console.log(`  UUID-based: ${uuidLocations.length}`);
                console.log(`  Place ID-based: ${placeIdLocations.length} ‚Üê will migrate\n`);

                if (placeIdLocations.length === 0) {
                    console.log('‚úÖ No Place ID locations found. All locations already use UUIDs!');
                    showStatus('‚úÖ No migration needed - all locations already use UUIDs!', 'success');
                    document.getElementById('previewBtn').disabled = false;
                    return;
                }

                // Generate migration plan
                console.log('üìã Migration plan:\n');
                const migrationMap = new Map();
                const migratedLocations = [];

                locations.forEach(loc => {
                    if (isPlaceId(loc.id)) {
                        const oldId = loc.id;
                        const newId = generateUUID();
                        migrationMap.set(oldId, newId);

                        console.log(`üìç ${loc.name}`);
                        console.log(`   Old ID (Place ID): ${oldId}`);
                        console.log(`   New ID (UUID): ${newId}`);
                        console.log(`   Place ID preserved: ‚úì\n`);

                        migratedLocations.push({
                            ...loc,
                            id: newId,
                            place_id: oldId,
                            _legacy_id: oldId,
                            _migrated_at: new Date().toISOString()
                        });
                    } else {
                        migrationMap.set(loc.id, loc.id);
                        migratedLocations.push(loc);
                    }
                });

                // Count affected costs
                const affectedCosts = costs.filter(cost => {
                    const destId = cost.destination_id || cost.destinationId;
                    return migrationMap.has(destId) && migrationMap.get(destId) !== destId;
                });

                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üìä MIGRATION SUMMARY');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log(`Locations to migrate: ${placeIdLocations.length}`);
                console.log(`Costs to update: ${affectedCosts.length}`);
                console.log(`Place IDs to preserve: ${placeIdLocations.length}`);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

                console.log('‚úÖ Preview complete! This was a dry-run - no changes made.');
                console.log('Click "Execute Migration" to apply these changes.\n');

                // Store migration plan
                migrationPlan = {
                    scenarioId,
                    migrationMap,
                    migratedLocations,
                    placeIdCount: placeIdLocations.length,
                    costCount: affectedCosts.length
                };

                showStatus(`‚úÖ Preview complete! Would migrate ${placeIdLocations.length} locations and update ${affectedCosts.length} costs.`, 'success');
                document.getElementById('migrateBtn').disabled = false;
                document.getElementById('previewBtn').disabled = false;

            } catch (error) {
                console.error('Preview failed:', error);
                showStatus(`‚ùå Preview error: ${error.message}`, 'error');
                document.getElementById('previewBtn').disabled = false;
            }
        };

        window.runMigration = async function() {
            if (!migrationPlan) {
                showStatus('‚ö†Ô∏è Please run preview first!', 'error');
                return;
            }

            if (!confirm(`‚ö†Ô∏è This will migrate ${migrationPlan.placeIdCount} locations from Place IDs to UUIDs.\n\nPlace IDs will be preserved in the place_id field.\n\nContinue?`)) {
                return;
            }

            logDiv.textContent = '';
            showStatus('üöÄ Executing migration...', 'warning');
            document.getElementById('migrateBtn').disabled = true;
            document.getElementById('previewBtn').disabled = true;

            try {
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üöÄ EXECUTING MIGRATION');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

                const workingData = getWorkingData();
                const costs = workingData.costs || [];
                const legs = workingData.legs || [];

                // Update locations
                console.log('üîÑ Updating locations...');
                workingData.locations = migrationPlan.migratedLocations;
                console.log(`‚úÖ Updated ${migrationPlan.placeIdCount} locations\n`);

                // Update costs
                console.log('üîÑ Updating costs...');
                const migratedCosts = costs.map(cost => {
                    const destId = cost.destination_id || cost.destinationId;
                    const newId = migrationPlan.migrationMap.get(destId);

                    if (newId && newId !== destId) {
                        return {
                            ...cost,
                            destination_id: newId,
                            _legacy_destination_id: destId,
                            _migrated_at: new Date().toISOString()
                        };
                    }
                    return cost;
                });
                workingData.costs = migratedCosts;
                console.log(`‚úÖ Updated ${migrationPlan.costCount} costs\n`);

                // Update legs
                console.log('üîÑ Updating legs...');
                workingData.legs = legs.map(leg => ({
                    ...leg,
                    sub_legs: (leg.sub_legs || []).map(subLeg => {
                        const newDestIds = (subLeg.destination_ids || []).map(id =>
                            migrationPlan.migrationMap.get(id) || id
                        );
                        return {
                            ...subLeg,
                            destination_ids: newDestIds
                        };
                    })
                }));
                console.log(`‚úÖ Updated leg references\n`);

                // Save costs to API
                console.log('üíæ Saving costs to API...\n');

                const costsByDest = new Map();
                migratedCosts.forEach(cost => {
                    const destId = cost.destination_id;
                    if (!costsByDest.has(destId)) {
                        costsByDest.set(destId, []);
                    }
                    costsByDest.get(destId).push(cost);
                });

                let savedCount = 0;
                let failedCount = 0;

                for (const [destId, destCosts] of costsByDest) {
                    const location = workingData.locations.find(l => l.id === destId);
                    const destName = location ? location.name : 'Unknown';

                    try {
                        const response = await fetch('http://localhost:5001/api/costs/bulk-save', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: migrationPlan.scenarioId,
                                scenario_id: migrationPlan.scenarioId,
                                destination_id: destId,
                                destination_name: destName,
                                cost_items: destCosts
                            })
                        });

                        if (response.ok) {
                            savedCount++;
                            console.log(`  ‚úÖ Saved ${destCosts.length} costs for ${destName}`);
                        } else {
                            failedCount++;
                            console.error(`  ‚ùå Failed to save costs for ${destName}: ${response.statusText}`);
                        }
                    } catch (error) {
                        failedCount++;
                        console.error(`  ‚ùå Error saving costs for ${destName}:`, error.message);
                    }
                }

                console.log(`\nüíæ Save results: ${savedCount} succeeded, ${failedCount} failed\n`);

                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('‚úÖ MIGRATION COMPLETE!');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

                console.log(`Migrated: ${migrationPlan.placeIdCount} locations`);
                console.log(`Updated: ${migrationPlan.costCount} costs`);
                console.log(`Saved: ${savedCount}/${costsByDest.size} destination costs\n`);

                console.log('‚ö†Ô∏è IMPORTANT NEXT STEPS:');
                console.log('1. Return to the main app');
                console.log('2. SAVE your scenario to persist location changes');
                console.log('3. Verify costs are correctly associated\n');

                showStatus(`‚úÖ Migration complete! Migrated ${migrationPlan.placeIdCount} locations. NOW SAVE YOUR SCENARIO IN THE MAIN APP!`, 'success');

                setTimeout(() => {
                    if (confirm('Migration complete!\n\nYou MUST save the scenario in the main app to persist changes.\n\nReturn to main app now?')) {
                        if (window.opener) {
                            window.close();
                        } else {
                            window.location.href = '/web/index.html';
                        }
                    }
                }, 2000);

            } catch (error) {
                console.error('Migration failed:', error);
                showStatus(`‚ùå Migration error: ${error.message}`, 'error');
                document.getElementById('migrateBtn').disabled = false;
                document.getElementById('previewBtn').disabled = false;
            }
        };

        // Auto-populate scenario ID
        window.addEventListener('load', () => {
            const scenarioId = getScenarioId();
            if (scenarioId) {
                console.log(`‚úÖ Scenario ID loaded: ${scenarioId}`);
                console.log('Click "Preview Migration" to see what will change.');
            } else {
                console.log('‚ö†Ô∏è No scenario ID found.');
                console.log('Please open this page from the main app or enter scenario ID manually.');
            }
        });

        console.log('‚úÖ Place ID to UUID Migration Tool loaded!');
    </script>
</body>
</html>
